# =============================================================================
# CryptoViz - Mac Docker Desktop Override
# =============================================================================
#
# This file contains Mac-specific overrides for docker-compose.yml
# Mac Docker Desktop doesn't support some Linux-specific mount options
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.mac.yml up
#
# Or use the Makefile:
#   make mac-start
#   make mac-start-monitoring
#
# =============================================================================

services:
  # Node Exporter - Remove rslave bind propagation
  # Mac Docker Desktop doesn't support rslave mount propagation
  node-exporter:
    volumes:
      # Override: Remove rslave (not supported on Mac)
      # Original: - /:/host:ro,rslave
      - /:/host:ro

  # cAdvisor - Simplified volume mounts for Mac
  # Some cAdvisor volume mounts can cause issues on Mac
  cadvisor:
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      # Removed /dev/disk/ mount - can be problematic on Mac
    devices: []  # Clear devices list (kmsg not accessible on Mac)
    privileged: false  # Disable privileged mode on Mac

# =============================================================================
# Mac-Specific Notes:
# =============================================================================
#
# 1. Volume Mount Propagation:
#    - Mac Docker Desktop doesn't support rslave/rshared propagation modes
#    - All mounts default to rprivate on Mac
#
# 2. Device Access:
#    - /dev/kmsg and similar devices aren't accessible on Mac
#    - cAdvisor runs in non-privileged mode with reduced metrics
#
# 3. File System Differences:
#    - Some Linux paths don't exist on Mac (/proc, /sys differ)
#    - Performance may vary due to osxfs/virtio-fs overhead
#
# 4. Known Limitations:
#    - Node Exporter: Reduced system metrics (no rslave access)
#    - cAdvisor: Fewer container metrics (no privileged mode)
#    - Overall: Slightly less detailed metrics than Linux hosts
#
# 5. Docker Network Issues:
#    - If you see "network not found" errors, run: docker network prune -f
#    - This cleans up stale network references from previous runs
#
# 6. Backfill State File:
#    - Should be at: services/data-collector/backfill_state.json
#    - If missing, backfill will run on every restart
#    - Check with: ls -la services/data-collector/*.json
#
# =============================================================================
